name: CI

on:
  push:
  pull_request:
  release:
    types:
      - created

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
        with:
          lfs: true

      - name: Use Node.js 14.x
        uses: actions/setup-node@v1
        with:
          node-version: 14.x

      - name: "kernel: npm ci"
        working-directory: kernel
        run: npm ci

      - name: "kernel: build"
        working-directory: kernel
        run: make update-renderer-master build-deploy

      - name: "kernel: build test-scenes"
        working-directory: kernel
        run: make test-scenes

      - name: "kernel: test"
        working-directory: kernel
        run: make test-ci

      - name: "website: npm ci"
        working-directory: website
        run: npm ci && sh scripts/post-install.sh

      - name: "website: add PUBLIC_URL to .env"
        working-directory: website
        run: |
          if [[ "$GITHUB_HEAD_REF" =~ ^(master|staging|release)$ ]]; then
            echo "skipped";
          else
            echo "PUBLIC_URL=\"https://play.decentraland.zone/branch/${GITHUB_HEAD_REF}\"" >> .env;
            cat .env
          fi

      - name: "website: test"
        working-directory: website
        run: npm test -- --watchAll=false

      - name: "website: build"
        working-directory: website
        run: npm run build

      - name: "website: deploy"
        run: echo 'placeholder'

      - name: "website: Comment PR with link"
        uses: thollander/actions-comment-pull-request@master
        with:
          message: "This branch can be previewed at [https://explorer.decentraland.zone/branch/${{ github.head_ref }}/index.html](https://explorer.decentraland.zone/branch/${{ github.head_ref }}/index.html?ENV=org)"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "kernel: publish"
        run: echo 'placeholder'
